<!DOCTYPE HTML>
<html>
    <head>
        <!-- タイトル -->
        <title>ガントチャート</title>
        <!-- エンコード -->
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <!-- CSS -->
        <link href="css/gannt_practice.css" rel="styleSheet">
        <link href="css/lib/jquery-ui.min.css" rel="stylesheet">
        <!-- JAVASCRIPT -->
        <script src="javascript/lib/jquery-3.6.1.min.js"></script>
        <script src="javascript/lib/jquery-ui.min.js"></script>
        <script src="javascript/gannt_practice.js"></script>
    </head>

    <body>

        <!-- ヘッダー -->
        <header>
            <!-- インデント変更ボタンエリア -->
            <span id="indentDiv">
                <button id="indent_left">←</button>
                <button id="indent_right">→</button>
            </span>
        </header>

        <!-- ガントチャート -->
        <main>
            <!-- テーブルヘッダー ---------------------------------------------------------------------->
            <table class="column_header column_table">
                <thead>
                    <tr>
                        <!-- 入力列 -->
                        <th rowspan="3" class="fixed">No</th>
                        <th rowspan="3" class="fixed">作業名</th>
                        <th rowspan="3">担当者</th>
                        <th rowspan="3">進捗率</th>
                        <th rowspan="3">状況</th>
                        <th colspan="3">予定</th>
                        <th colspan="3">実績</th>
                        <th rowspan="3">先行</th>
                        <!-- 日付列 -->
                        <th id="head_year_month" colspan="11"></th>
                    </tr>
                    <tr>
                        <!-- 入力列 - 結合対象セル(CSS設定の兼ね合いで非表示セルを配置) -->
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <!-- 入力列 - 2行目 -->
                        <th rowspan="2">開始日</th>
                        <th rowspan="2">終了日</th>
                        <th rowspan="2">日数</th>
                        <th rowspan="2">開始日</th>
                        <th rowspan="2">終了日</th>
                        <th rowspan="2">日数</th>
                        <th class="none"></th>
                        <!-- 日付列 -->
                        <th class="col_day head_dates"></th>
                        <th class="col_day head_dates"></th>
                        <th class="col_day head_dates"></th>
                        <th class="col_day head_dates"></th>
                        <th class="col_day head_dates"></th>
                        <th class="col_day head_dates"></th>
                        <th class="col_day head_dates"></th>
                        <th class="col_day head_dates"></th>
                        <th class="col_day head_dates"></th>
                        <th class="col_day head_dates"></th>
                        <th class="col_day head_dates"></th>
                    </tr>
                    <tr>
                        <!-- 入力列 - 結合対象セル(CSS設定の兼ね合いで非表示セルを配置) -->
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <th class="none"></th>
                        <!-- 日付列 -->
                        <th class="head_days"></th>
                        <th class="head_days"></th>
                        <th class="head_days"></th>
                        <th class="head_days"></th>
                        <th class="head_days"></th>
                        <th class="head_days"></th>
                        <th class="head_days"></th>
                        <th class="head_days"></th>
                        <th class="head_days"></th>
                        <th class="head_days"></th>
                        <th class="head_days"></th>
                    </tr>
                </thead>
            </table>

            <!-- テーブルボディ ---------------------------------------------------------------------->
            <table class="column_body column_table">
                <tbody id="column_table_body" class="ui-sortable">
                    <tr class="one">
                        <!-- 入力列 -->
                        <td class="fixed">1</td>
                        <td class="fixed task_title">ユーザー一覧画面作成</td>
                        <td>Aさん</td>
                        <td>
                            <input type="range" step="10" value="0" id="prog_1" class="prog" min="0" max="100">
                        </td>
                        <td>進行中</td>
                        <td>
                            <input type="date" id="planSt_1" class="planSt dateInpt">
                        </td>
                        <td>
                            <input type="date" id="planEd_1" class="planEd dateInpt">
                        </td>
                        <td id="planDif_1"></td>
                        <td>
                            <input type="date" id="actSt_1" class="actSt dateInpt">
                        </td>
                        <td>
                            <input type="date" id="actEd_1" class="actEd dateInpt">
                        </td>
                        <td id="actDif_1"></td>
                        <td></td>
                        <!-- 日付列 -->
                        <td class="col_day">
                            <div id="planBar_1" class="planBar bar">
                                <div id="progBar_1" class="progBar"></div>
                            </div>
                            <div id="actBar_1" class="actBar bar"></div>
                        </td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                    </tr>
                    <tr class="two">
                        <!-- 入力列 -->
                        <td class="fixed">2</td>
                        <td class="fixed task_title">ユーザー登録画面作成</td>
                        <td>Bさん</td>
                        <td>
                            <input type="range" step="10" value="0" id="prog_2" class="prog" min="0" max="100">
                        </td>
                        <td>進行中</td>
                        <td>
                            <input type="date" id="planSt_2" class="planSt dateInpt">
                        </td>
                        <td>
                            <input type="date" id="planEd_2" class="planEd dateInpt">
                        </td>
                        <td id="planDif_2"></td>
                        <td>
                            <input type="date" id="actSt_2" class="actSt dateInpt">
                        </td>
                        <td>
                            <input type="date" id="actEd_2" class="actEd dateInpt">
                        </td>
                        <td id="actDif_2"></td>
                        <td></td>
                        <!-- 日付列 -->
                        <td class="col_day">
                            <div id="planBar_2" class="planBar bar">
                                <div id="progBar_2" class="progBar"></div>
                            </div>
                            <div id="actBar_2" class="actBar bar"></div>
                        </td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                    </tr>
                    <tr class="three">
                        <!-- 入力列 -->
                        <td class="fixed">3</td>
                        <td class="fixed task_title">ユーザー削除画面作成</td>
                        <td>Cさん</td>
                        <td>
                            <input type="range" step="10" value="0" id="prog_3" class="prog" min="0" max="100">
                        </td>
                        <td>進行中</td>
                        <td>
                            <input type="date" id="planSt_3" class="planSt dateInpt">
                        </td>
                        <td>
                            <input type="date" id="planEd_3" class="planEd dateInpt">
                        </td>
                        <td id="planDif_3"></td>
                        <td>
                            <input type="date" id="actSt_3" class="actSt dateInpt">
                        </td>
                        <td>
                            <input type="date" id="actEd_3" class="actEd dateInpt">
                        </td>
                        <td id="actDif_3"></td>
                        <td></td>
                        <!-- 日付列 -->
                        <td class="col_day">
                            <div id="planBar_3" class="planBar bar">
                                <div id="progBar_3" class="progBar"></div>
                            </div>
                            <div id="actBar_3" class="actBar bar"></div>
                        </td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                        <td class="col_day"></td>
                    </tr>
                </tbody>
            </table>
        </main>

        <script>
            window.onload = () => {
                changeRows()
                init()
                setChangeEventDate()
            }

            // テーブルヘッダに今日から10日分の日付けを書き出す
            const weekOfDays = ["日", "月", "火", "水", "木", "金", "土",]
            const year = new Date().getFullYear()
            const month = ("00" + (new Date().getMonth() + 1)).slice(-2)
            const date = new Date().getDate()
            const day = new Date().getDay()
            $("#head_year_month").html(`${year}/${month}`)
            $(".head_dates").each((i, col) => { col.innerHTML = ("00" + (date + i)).slice(-2) })
            $(".head_days").each((i, col) => {
                weekOfDay = (day + i) % 7
                col.innerHTML = weekOfDays[weekOfDay]
            })
            // 今日の日付をYYYY-MM-DDで表示
            const today = `${year}-${month}-${("00" + (date)).slice(-2)}`
            let lastDay = 0
            // 各行の予定表列にクラス名で日付を付与する
            $("#column_table_body").children("tr").each((i, tableRow) => {
                tableRow.querySelectorAll(".col_day").forEach((col, index) => {
                    lastDay = `${year}-${month}-${("00" + (date + index)).slice(-2)}`
                    col.setAttribute("name", lastDay)
                })
            })
            // 選択済み行
            let selectedRows = []
            // 変更前テーブルの保持データ
            let tableRowsTmp = []
            // 変更後のテーブル行番号を格納する配列
            let tableRowsIndex = []

            // 変更前のテーブルの状態を保持するための初期化
            function init() {
                $("#column_table_body").children("tr").each((i, tableRow) => {
                    tableRowsTmp[i] = tableRow.cloneNode(true);
                    tableRowsTmp[i].indentIndex = 0
                    tableRowsIndex.push(i)
                })
            }

            // 選択、行入れ替え機能の付与
            function changeRows() {
                $("#column_table_body").selectable({
                    cancel: ".ui-selected",
                    selected: (e, item) => {
                        selectedRows = $("tr.ui-selected").clone();
                    }
                }).sortable({
                    // 縦方向限定
                    axis: 'y',
                    // 現在ドラッグ対象のオブジェクト（今回はテーブル行）
                    items: "tr",
                    // 並び替えヘルパーのオブジェクト
                    helper: function (e, item) {
                        selectedRows = $("tr.ui-selected").clone();
                        // 要素移動中、掴んだ要素とその兄弟要素はテーブルから削除する
                        item.data(selectedRows).siblings('.ui-selected').remove();
                        return $("<tr>").append(selectedRows)
                    },
                    stop: function (e, item) {
                        // 移動した先に掴んでいる要素の先頭の要素がitemに入る（1.2を持っていたら1）
                        item.item.after(selectedRows)
                        // 1.2を持っていたら「1.1.2」となるので要素を削除する
                        item.item.remove()
                        // 選択済みクラスを全て削除
                        $(".ui-selected").each((i, elem) => {
                            elem.classList.remove("ui-selected")
                        })
                        // 変更後のインデックスを取得
                        tableRowsIndex = []
                        $(this).children("tr").each((i, changedRow) => {
                            for (let j = 0; j < tableRowsTmp.length; j++) {
                                if (tableRowsTmp[j].isEqualNode(changedRow)) {
                                    tableRowsIndex.push(j)
                                }
                            }
                        })
                        // changeイベントの振り直し
                        setChangeEventDate()
                    }
                })
            }

            // インデントボタンを押された際の処理
            function indent(direction) {
                const tableRows = $("#column_table_body").children("tr")
                // changedIndex ... 変更後のインデックスが入っている配列
                // orgIndex ... 0から正順で回るインデックス
                tableRowsIndex.forEach((changedIndex, orgIndex) => {
                    for (let i = 0; i < selectedRows.length; i++) {
                        // テーブル行と選択した行が同じものの場合、ボタンの向きに応じてインデント用のインデックスを加減
                        if (tableRows[changedIndex].isEqualNode(selectedRows[i])) {
                            if (direction === "left" && tableRowsTmp[orgIndex].indentIndex > 0) {
                                tableRowsTmp[orgIndex].indentIndex--
                            }
                            else if (direction === "right" && tableRowsTmp[orgIndex].indentIndex < 3) {
                                tableRowsTmp[orgIndex].indentIndex++
                            }
                            // 表示中のテーブルのタイトルにインデントを付与
                            tableRows[changedIndex].querySelector(".task_title").style.textIndent = `${tableRowsTmp[orgIndex].indentIndex * 12}px`
                            // 選択済み行もインデントを付与した状態に更新
                            selectedRows[i] = tableRows[changedIndex]
                            // テーブル行の保持データを更新。テーブルからデータを複製しインデントインデックスは前回の値を引き継ぐ
                            const indentIndexTmp = tableRowsTmp[orgIndex].indentIndex
                            tableRowsTmp[orgIndex] = tableRows[changedIndex].cloneNode(true)
                            tableRowsTmp[orgIndex].indentIndex = indentIndexTmp
                            // 比較に扱いやすいデータにするため選択済みクラスは外す
                            tableRowsTmp[orgIndex].classList.remove("ui-selected")
                            for (let selected of tableRowsTmp[orgIndex].querySelectorAll(".ui-selected")) {
                                selected.classList.remove("ui-selected")
                            }
                        }
                    }
                })
            }
            $("#indent_left").on("click", () => indent("left"))
            $("#indent_right").on("click", () => indent("right"))

            // カレンダー入力にchangeイベントを付与。
            function setChangeEventDate() {
                $("[id*='planSt_']").each((i) => { $(`#planSt_${i + 1}`).change(() => { checkDate(event, i + 1, "plan") }) })
                $("[id*='planEd_']").each((i) => { $(`#planEd_${i + 1}`).change(() => { checkDate(event, i + 1, "plan") }) })
                $("[id*='actSt_']").each((i) => { $(`#actSt_${i + 1}`).change(() => { checkDate(event, i + 1, "act") }) })
                $("[id*='actEd_']").each((i) => { $(`#actEd_${i + 1}`).change(() => { checkDate(event, i + 1, "act") }) })
            }
            // 日付けがセットされた後の挙動
            function checkDate(event, index, process) {
                // 日付けをセットした行を取得
                const stDate = $(`#${process}St_${index}`).val()
                const edDate = $(`#${process}Ed_${index}`).val()
                // 終了日は開始日以前を設定できないようにする
                $(`#${process}Ed_${index}`).attr("min", stDate)
                //開始、終了の日付けがセットされているか確認
                if (stDate !== "" && edDate !== "") {
                    // 、予定、実績それぞれの開始/終了がセットされていれば差分を計算する
                    const diffDay = setDiffDay(stDate, edDate, process, index)
                    // チャート出力
                    setChartBar(stDate, edDate, diffDay, process, index)
                }
            }
            // 設定した開始日、終了日の情報をもとにチャートバーを作成
            function setChartBar(stDate, edDate, diffDay, process, index) {
                // もしも差分日数が0かマイナス値になっていた場合はバーを非表示にして早期return
                if (diffDay < 1) {
                    $(`#${process}Bar_${index}`).css("display", "none")
                    return
                }
                // 日付けをセットした行を取得
                const selectedRow = $(`#${process}St_${index}`).parent().parent()

                // 非表示にしたバーを再表示
                $(`#${process}Bar_${index}`).css("display", "block")
                // チャートの起点を決める
                let selectedDateCol = selectedRow.children(`td[name=${stDate}]`)
                if (stDate < today) {
                    // 本日以前の日付けを選んだ場合、起点は本日とする
                    selectedDateCol = selectedRow.children(`td[name=${today}]`)
                } else if (selectedRow.children(`td[name=${stDate}]`).length < 1) {
                    // テーブルにない日付けを開始日に選択した場合、バーを消して早期return
                    $(`#${process}Bar_${index}`).css("display", "none")
                    return
                }

                // 起点は全ての日付けカラム内の何番目か
                let startColumnIndex = 0
                let columnCount = 0
                selectedRow.children(".col_day").each((i, column) => {
                    if (column.isEqualNode(selectedDateCol[0])) {
                        startColumnIndex = i
                    }
                    columnCount = i + 1
                })

                // 差分がバーのチャートバーのカラムサイズとなる
                let barColumCount = diffDay
                // 開始日が本日の日付け以前の場合、開始日から本日までの差分を取得
                if (stDate < today) {
                    const diffDayForToday = setDiffDay(stDate, today)
                    barColumCount -= diffDayForToday - 1
                }

                // 差分が起点以降の空きカラム数を超えたらバーのサイズは空きカラムの領域を超えないようにする
                if (barColumCount > (columnCount - startColumnIndex)) {
                    barColumCount = columnCount - startColumnIndex
                }
                // 1本分のボーダーサイズを取得
                const border = (selectedDateCol.outerWidth() - selectedDateCol.innerWidth()) / 2
                // 要素の幅+ボーダー*カラム数でバーサイズを計算
                const barSize = ((selectedDateCol.innerWidth() + border) * barColumCount)
                // 起点と終端のpadding = 1px分を調整しバーの幅を設定
                $(`#${process}Bar_${index}`).css("width", `${barSize - 2}px`)
                // 起点の情報を取得出来たらバーを設定した起点に移動
                if (selectedDateCol.length > 0) selectedDateCol.append($(`#${process}Bar_${index}`))
            }
            // 予定、実績にセットされた日付けの差分を計算
            function setDiffDay(stDate, edDate, process, index) {
                const startDate = new Date(stDate)
                const endDate = new Date(edDate)
                const diffTime = endDate.getTime() - startDate.getTime()
                const diffDay = Math.floor(diffTime / (1000 * 60 * 60 * 24))
                $(`#${process}Dif_${index}`).html(diffDay + 1)
                return diffDay + 1
            }
        </script>
    </body>
</html>
